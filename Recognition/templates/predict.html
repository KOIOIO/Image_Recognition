<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾åƒé¢„æµ‹ - å›¾åƒè¯†åˆ«å¤§è¯¾è®¾</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .section-title {
            margin-bottom: 30px;
            color: #343a40;
            font-weight: 600;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #667eea;
            border-color: #667eea;
        }
        .btn-primary:hover {
            background-color: #5a67d8;
            border-color: #5a67d8;
        }
        .btn-secondary {
            background-color: #48bb78;
            border-color: #48bb78;
        }
        .btn-secondary:hover {
            background-color: #38a169;
            border-color: #38a169;
        }
        .upload-area {
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
            cursor: pointer;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f0f2ff;
        }
        .upload-area.active {
            border-color: #48bb78;
            background-color: #f0fff4;
        }
        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 15px;
        }
        .image-preview {
            display: none;
            margin-top: 20px;
        }
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .predict-results {
            margin-top: 30px;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .prediction-status {
            font-weight: 600;
        }
        .status-pending {
            color: #ffc107;
        }
        .status-processing {
            color: #17a2b8;
        }
        .status-completed {
            color: #28a745;
        }
        .status-error {
            color: #dc3545;
        }
        .main-prediction {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .prediction-class {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }
        .prediction-confidence {
            font-size: 1.2rem;
            color: #48bb78;
        }
        .confidence-chart {
            margin-top: 30px;
        }
        .prediction-details {
            margin-top: 30px;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .detail-label {
            font-weight: 500;
        }
        .detail-bar {
            flex: 1;
            margin: 0 15px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }
        .detail-progress {
            height: 100%;
            background-color: #667eea;
            transition: width 0.6s ease;
        }
        .detail-value {
            font-weight: 600;
            min-width: 60px;
            text-align: right;
        }
        .confidence-low .detail-progress {
            background-color: #dc3545;
        }
        .confidence-medium .detail-progress {
            background-color: #ffc107;
        }
        .confidence-high .detail-progress {
            background-color: #48bb78;
        }
        .sample-images {
            margin-top: 30px;
        }
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .sample-item {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 2px solid transparent;
        }
        .sample-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        .sample-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        .example-card {
            display: inline-block;
            margin: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            width: calc(25% - 20px);
            max-width: 200px;
        }
        .example-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .example-info {
            padding: 10px;
            background-color: #f8f9fa;
        }
        .true-label {
            font-weight: 600;
            color: #28a745;
            margin-bottom: 5px;
        }
        .pred-label {
            color: #667eea;
        }
        .note {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">å›¾åƒè¯†åˆ«å¤§è¯¾è®¾</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/prepare_data">æ•°æ®å‡†å¤‡</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/config">æ¨¡å‹é…ç½®</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/train">æ¨¡å‹è®­ç»ƒ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/results">è®­ç»ƒç»“æœ</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/predict">å›¾åƒé¢„æµ‹</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="section-title">å›¾åƒé¢„æµ‹</h1>
        
        <div class="row">
            <!-- å·¦ä¾§ï¼šå›¾åƒä¸Šä¼ åŒºåŸŸ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h3>ä¸Šä¼ å›¾åƒ</h3>
                        
                        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                        <div class="upload-area" id="upload-area">
                            <div class="upload-icon">ğŸ“</div>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾åƒåˆ°æ­¤å¤„ä¸Šä¼ </p>
                            <p class="text-muted small">æ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 5MB</p>
                            <input type="file" id="file-input" accept="image/*" style="display: none;">
                        </div>
                        
                        <!-- ä¸Šä¼ çš„å›¾åƒé¢„è§ˆ -->
                        <div class="image-preview" id="image-preview">
                            <img src="" alt="é¢„è§ˆå›¾åƒ" class="preview-image" id="preview-image">
                            <div class="text-center mt-3">
                                    <div class="d-flex justify-content-center align-items-center">
                                        <select id="model-select" class="form-select me-2" style="max-width:300px;">
                                            <option value=""></option>
                                        </select>
                                        <div id="model-info" style="margin-left:12px; text-align:left; max-width:400px;">
                                            <!-- æ¨¡å‹å‚æ•°å’Œç¼©ç•¥å›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                        </div>
                                        <button class="btn btn-outline-secondary me-2" id="refresh-models">åˆ·æ–°æ¨¡å‹</button>
                                        <button class="btn btn-primary" id="predict-btn">
                                            ğŸ” å¼€å§‹é¢„æµ‹
                                        </button>
                                    </div>
                                <button class="btn btn-secondary ml-2" id="clear-btn">
                                    â†» é‡æ–°ä¸Šä¼ 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç¤ºä¾‹å›¾åƒ -->
                <div class="card sample-images">
                    <div class="card-body">
                        <h3>ç¤ºä¾‹å›¾åƒ</h3>
                        <p>ç‚¹å‡»ä¸‹æ–¹ç¤ºä¾‹å›¾åƒç›´æ¥è¿›è¡Œé¢„æµ‹ï¼š</p>
                        <div class="sample-grid" id="sample-grid">
                            <!-- ç¤ºä¾‹å›¾åƒå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                
                <!-- é¢„æµ‹ç¤ºä¾‹ -->
                <div class="card prediction-examples">
                    <div class="card-body">
                        <h3>é¢„æµ‹ç¤ºä¾‹</h3>
                        <p>ä»¥ä¸‹æ˜¯æ¨¡å‹é¢„æµ‹çš„ä¸€äº›ç¤ºä¾‹ï¼š</p>
                        <div id="prediction-examples" class="prediction-examples-container">
                            <!-- é¢„æµ‹ç¤ºä¾‹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šé¢„æµ‹ç»“æœ -->
            <div class="col-md-6">
                <div class="card predict-results">
                    <div class="card-body">
                        <div class="result-header">
                            <h3>é¢„æµ‹ç»“æœ</h3>
                            <span class="prediction-status status-pending" id="prediction-status">
                                â³ ç­‰å¾…å›¾åƒä¸Šä¼ 
                            </span>
                        </div>
                        
                        <!-- ä¸»è¦é¢„æµ‹ç»“æœ -->
                        <div class="main-prediction" id="main-prediction">
                            <div class="prediction-class" id="prediction-class">--</div>
                            <div class="prediction-confidence" id="prediction-confidence">--</div>
                        </div>
                        
                        <!-- è¯¦ç»†é¢„æµ‹ç»“æœ -->
                        <div class="prediction-details" id="prediction-details">
                            <h4>åˆ†ç±»æ¦‚ç‡è¯¦æƒ…</h4>
                            <!-- è¯¦æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <div class="note">
                            <strong>æç¤ºï¼š</strong> é¢„æµ‹ç»“æœä»…ä¾›å‚è€ƒï¼Œå®é™…åº”ç”¨ä¸­è¯·ç»“åˆå…·ä½“åœºæ™¯è¿›è¡ŒéªŒè¯ã€‚æ¨¡å‹åœ¨å¤„ç†éå¸¸è§„è§’åº¦æˆ–å…‰ç…§æ¡ä»¶ä¸‹çš„å›¾åƒæ—¶ï¼Œå‡†ç¡®ç‡å¯èƒ½ä¼šé™ä½ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-10 py-5 bg-dark text-white">
        <div class="container text-center">
            <p>&copy; 2023 å›¾åƒè¯†åˆ«å¤§è¯¾è®¾ - æ·±åº¦å­¦ä¹ é¡¹ç›®</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMå…ƒç´ 
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const imagePreview = document.getElementById('image-preview');
            const previewImage = document.getElementById('preview-image');
            const predictBtn = document.getElementById('predict-btn');
            const clearBtn = document.getElementById('clear-btn');
            const predictionStatus = document.getElementById('prediction-status');
            const predictionClass = document.getElementById('prediction-class');
            const predictionConfidence = document.getElementById('prediction-confidence');
            const predictionDetails = document.getElementById('prediction-details');
            const sampleGrid = document.getElementById('sample-grid');
            
            // ç±»åˆ«åç§°
            let classNames = ['é£æœº', 'æ±½è½¦', 'é¸Ÿ', 'çŒ«', 'é¹¿', 'ç‹—', 'é’è›™', 'é©¬', 'èˆ¹', 'å¡è½¦'];
            
            // ä»æœåŠ¡å™¨åŠ è½½å®é™…çš„ç±»åˆ«åç§°
            function loadClassNames() {
                fetch('static/class_names.json')
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error('æ— æ³•åŠ è½½ç±»åˆ«åç§°');
                    })
                    .then(data => {
                        if (data && data.length > 0) {
                            classNames = data;
                        }
                    })
                    .catch(error => {
                        console.log('ä½¿ç”¨é»˜è®¤ç±»åˆ«åç§°:', error);
                    });
            }
            
            // åˆå§‹åŒ–ç¤ºä¾‹å›¾åƒ
            function initSampleImages() {
                // æœ¬åœ°æµ‹è¯•æ•°æ®é›†çš„å›¾ç‰‡æ˜ å°„
                const sampleImages = [
                    { classIndex: 0, folder: 'plane', file: 'image_115.png' },
                    { classIndex: 1, folder: 'car', file: 'image_136.png' },
                    { classIndex: 2, folder: 'bird', file: 'image_108.png' },
                    { classIndex: 3, folder: 'cat', file: 'image_101.png' },
                    { classIndex: 4, folder: 'deer', file: 'image_158.png' },
                    { classIndex: 5, folder: 'dog', file: 'image_107.png' },
                    { classIndex: 6, folder: 'frog', file: 'image_0.png' },
                    { classIndex: 7, folder: 'horse', file: 'image_11.png' },
                    { classIndex: 8, folder: 'ship', file: 'image_139.png' },
                    { classIndex: 9, folder: 'truck', file: 'image_1.png' }
                ];
                
                // ç”Ÿæˆç¤ºä¾‹å›¾åƒ
                sampleImages.forEach(item => {
                    const sampleItem = document.createElement('div');
                    sampleItem.className = 'sample-item';
                    sampleItem.dataset.classIndex = item.classIndex;
                    
                    const img = document.createElement('img');
                    img.className = 'sample-img';
                    // ä½¿ç”¨ç›¸å¯¹è·¯å¾„è®¿é—®æµ‹è¯•æ•°æ®é›†å›¾ç‰‡
                    img.src = `/api/get_sample_image?folder=${item.folder}&file=${item.file}`;
                    img.alt = classNames[item.classIndex];
                    
                    sampleItem.appendChild(img);
                    sampleGrid.appendChild(sampleItem);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    sampleItem.addEventListener('click', function() {
                        // è®¾ç½®é¢„è§ˆå›¾åƒ
                        previewImage.src = img.src;
                        imagePreview.style.display = 'block';
                        uploadArea.style.display = 'none';
                        
                        // è‡ªåŠ¨é¢„æµ‹
                        setTimeout(() => {
                            predictImage(img.src, item.classIndex);
                        }, 500);
                    });
                });
            }
            
            // åˆå§‹åŒ–é¢„æµ‹ç¤ºä¾‹
            function initPredictionExamples() {
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é¢„æµ‹ç¤ºä¾‹å®¹å™¨
                const predictionExamplesContainer = document.getElementById('prediction-examples');
                if (!predictionExamplesContainer) {
                    return;
                }
                
                // é¢„æµ‹ç¤ºä¾‹æ•°æ®
                const predictionExamples = [
                    { folder: 'bird', file: 'image_120.png', trueLabel: 'é¸Ÿ', predLabel: 'æ±½è½¦' },
                    { folder: 'car', file: 'image_140.png', trueLabel: 'æ±½è½¦', predLabel: 'çŒ«' },
                    { folder: 'cat', file: 'image_17.png', trueLabel: 'çŒ«', predLabel: 'çŒ«' },
                    { folder: 'deer', file: 'image_20.png', trueLabel: 'é¹¿', predLabel: 'é¹¿' },
                    { folder: 'dog', file: 'image_128.png', trueLabel: 'ç‹—', predLabel: 'ç‹—' },
                    { folder: 'frog', file: 'image_125.png', trueLabel: 'é’è›™', predLabel: 'é©¬' },
                    { folder: 'horse', file: 'image_12.png', trueLabel: 'é©¬', predLabel: 'é£æœº' },
                    { folder: 'plane', file: 'image_129.png', trueLabel: 'é£æœº', predLabel: 'é£æœº' }
                ];
                
                // æ¸…ç©ºå®¹å™¨
                predictionExamplesContainer.innerHTML = '';
                
                // ç”Ÿæˆé¢„æµ‹ç¤ºä¾‹
                predictionExamples.forEach(example => {
                    const exampleCard = document.createElement('div');
                    exampleCard.className = 'example-card';
                    
                    const img = document.createElement('img');
                    img.className = 'example-image';
                    img.src = `/api/get_sample_image?folder=${example.folder}&file=${example.file}`;
                    img.alt = example.trueLabel;
                    
                    const exampleInfo = document.createElement('div');
                    exampleInfo.className = 'example-info';
                    
                    const trueLabel = document.createElement('div');
                    trueLabel.className = 'true-label';
                    trueLabel.textContent = `çœŸå®: ${example.trueLabel}`;
                    
                    const predLabel = document.createElement('div');
                    predLabel.className = 'pred-label';
                    predLabel.textContent = `é¢„æµ‹: ${example.predLabel}`;
                    
                    exampleInfo.appendChild(trueLabel);
                    exampleInfo.appendChild(predLabel);
                    exampleCard.appendChild(img);
                    exampleCard.appendChild(exampleInfo);
                    
                    predictionExamplesContainer.appendChild(exampleCard);
                });
            }
            
            // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
            function handleFileUpload(file) {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾åƒæ–‡ä»¶ï¼ˆJPGã€PNGã€WEBPï¼‰');
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (file.size > 5 * 1024 * 1024) { // 5MB
                    alert('å›¾åƒå¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    imagePreview.style.display = 'block';
                    uploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
            
            // ä»APIè·å–é¢„æµ‹ç»“æœ
            function predictImage(imageSrc, expectedClassIndex = null) {
                // æ›´æ–°çŠ¶æ€
                predictionStatus.className = 'prediction-status status-processing';
                predictionStatus.textContent = 'ğŸ”„ æ­£åœ¨åˆ†æå›¾åƒ...';
                
                // å¦‚æœæ˜¯ç¤ºä¾‹å›¾åƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                if (expectedClassIndex !== null) {
                    // æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
                    setTimeout(() => {
                        // ç”Ÿæˆæ¨¡æ‹Ÿé¢„æµ‹ç»“æœ
                        const predictions = [];
                        let total = 0;
                        
                        // ç”Ÿæˆéšæœºæ¦‚ç‡
                        const probabilities = [];
                        for (let i = 0; i < classNames.length; i++) {
                            // ç»™æœŸæœ›ç±»åˆ«æ›´é«˜çš„æ¦‚ç‡
                            if (expectedClassIndex !== null && i === expectedClassIndex) {
                                probabilities.push(Math.random() * 0.4 + 0.6); // 60%-100%
                            } else {
                                probabilities.push(Math.random() * 0.3); // 0%-30%
                            }
                            total += probabilities[i];
                        }
                        
                        // å½’ä¸€åŒ–æ¦‚ç‡
                        for (let i = 0; i < classNames.length; i++) {
                            predictions.push({
                                class: classNames[i],
                                confidence: probabilities[i] / total
                            });
                        }
                        
                        // æŒ‰æ¦‚ç‡æ’åº
                        predictions.sort((a, b) => b.confidence - a.confidence);
                        
                        // æ›´æ–°ä¸»è¦é¢„æµ‹ç»“æœ
                        const topPrediction = predictions[0];
                        predictionClass.textContent = topPrediction.class;
                        predictionConfidence.textContent = `ç½®ä¿¡åº¦: ${(topPrediction.confidence * 100).toFixed(2)}%`;
                        
                        // ç”Ÿæˆè¯¦ç»†é¢„æµ‹ç»“æœ
                        updatePredictionDetails(predictions);
                        
                        // æ›´æ–°çŠ¶æ€ä¸ºå®Œæˆ
                        predictionStatus.className = 'prediction-status status-completed';
                        predictionStatus.textContent = 'âœ… é¢„æµ‹å®Œæˆ';
                    }, 1500);
                    return;
                }
                
                // å¦‚æœæ˜¯ç”¨æˆ·ä¸Šä¼ çš„å›¾åƒï¼Œä½¿ç”¨APIè¿›è¡Œå®é™…é¢„æµ‹
                // ä»imageSrcåˆ›å»ºä¸€ä¸ªBlobå¯¹è±¡
                fetch(imageSrc)
                    .then(response => response.blob())
                    .then(blob => {
                        const formData = new FormData();
                        formData.append('image', blob, 'uploaded_image.jpg');
                        // é™„åŠ æ‰€é€‰æ¨¡å‹æ–‡ä»¶åï¼ˆå¦‚æœæœ‰ï¼‰
                        const modelSelect = document.getElementById('model-select');
                        if (modelSelect && modelSelect.value) {
                            formData.append('model_file', modelSelect.value);
                        }

                        return fetch('/api/predict', {
                            method: 'POST',
                            body: formData
                        });
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // æ›´æ–°ä¸»è¦é¢„æµ‹ç»“æœ
                            predictionClass.textContent = data.prediction;
                            predictionConfidence.textContent = `ç½®ä¿¡åº¦: ${data.confidence_level.toFixed(2)}%`;
                            
                            // å‡†å¤‡é¢„æµ‹è¯¦æƒ…æ•°æ®
                            const predictions = Object.entries(data.all_probabilities)
                                .map(([className, confidence]) => ({
                                    class: className,
                                    confidence: confidence / 100 // è½¬æ¢ä¸ºå°æ•°å½¢å¼
                                }))
                                .sort((a, b) => b.confidence - a.confidence);
                            
                            // æ›´æ–°è¯¦ç»†é¢„æµ‹ç»“æœ
                            updatePredictionDetails(predictions);
                            
                            // æ›´æ–°çŠ¶æ€ä¸ºå®Œæˆ
                            predictionStatus.className = 'prediction-status status-completed';
                            predictionStatus.textContent = 'âœ… é¢„æµ‹å®Œæˆ';
                        } else {
                            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            predictionClass.textContent = 'é¢„æµ‹å¤±è´¥';
                            predictionConfidence.textContent = data.message || 'æœªçŸ¥é”™è¯¯';
                            predictionStatus.className = 'prediction-status status-error';
                            predictionStatus.textContent = 'âŒ é¢„æµ‹å‡ºé”™';
                            predictionDetails.innerHTML = '<h4>åˆ†ç±»æ¦‚ç‡è¯¦æƒ…</h4><p>æ— æ³•è·å–é¢„æµ‹ç»“æœ</p>';
                        }
                    })
                    .catch(error => {
                        console.error('é¢„æµ‹è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                        predictionClass.textContent = 'é¢„æµ‹å¤±è´¥';
                        predictionConfidence.textContent = 'ç½‘ç»œé”™è¯¯';
                        predictionStatus.className = 'prediction-status status-error';
                        predictionStatus.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                        predictionDetails.innerHTML = '<h4>åˆ†ç±»æ¦‚ç‡è¯¦æƒ…</h4><p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨</p>';
                    });
            }
            
            // æ›´æ–°é¢„æµ‹è¯¦æƒ…UI
            function updatePredictionDetails(predictions) {
                predictionDetails.innerHTML = '<h4>åˆ†ç±»æ¦‚ç‡è¯¦æƒ…</h4>';
                predictions.forEach(pred => {
                    const confidencePercent = pred.confidence * 100;
                    let confidenceClass = 'confidence-low';
                    
                    if (confidencePercent > 70) {
                        confidenceClass = 'confidence-high';
                    } else if (confidencePercent > 30) {
                        confidenceClass = 'confidence-medium';
                    }
                    
                    const detailItem = document.createElement('div');
                    detailItem.className = 'detail-item';
                    
                    detailItem.innerHTML = `
                        <div class="detail-label">${pred.class}</div>
                        <div class="detail-bar">
                            <div class="detail-progress" style="width: ${confidencePercent}%;"></div>
                        </div>
                        <div class="detail-value">${confidencePercent.toFixed(2)}%</div>
                    `;
                    
                    // æ·»åŠ ç½®ä¿¡åº¦ç±»
                    detailItem.querySelector('.detail-bar').className += ` ${confidenceClass}`;
                    
                    predictionDetails.appendChild(detailItem);
                });
            }
            
            // é‡ç½®ä¸Šä¼ åŒºåŸŸ
            function resetUploadArea() {
                fileInput.value = '';
                imagePreview.style.display = 'none';
                uploadArea.style.display = 'flex';
                
                // é‡ç½®é¢„æµ‹ç»“æœ
                predictionStatus.className = 'prediction-status status-pending';
                predictionStatus.textContent = 'â³ ç­‰å¾…å›¾åƒä¸Šä¼ ';
                predictionClass.textContent = '--';
                predictionConfidence.textContent = '--';
                predictionDetails.innerHTML = '<h4>åˆ†ç±»æ¦‚ç‡è¯¦æƒ…</h4>';
            }
            
            // äº‹ä»¶ç›‘å¬å™¨
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    handleFileUpload(this.files[0]);
                }
            });
            
            // æ‹–æ‹½äº‹ä»¶
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('active');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                this.classList.remove('active');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('active');
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            // é¢„æµ‹æŒ‰é’®ç‚¹å‡»
            predictBtn.addEventListener('click', function() {
                if (previewImage.src) {
                    predictImage(previewImage.src);
                }
            });
            
            // æ¸…é™¤æŒ‰é’®ç‚¹å‡»
            clearBtn.addEventListener('click', resetUploadArea);
            
            // åˆå§‹åŒ–é¡µé¢
            loadClassNames();
            initSampleImages();
            initPredictionExamples();
            // åŠ è½½å¯ç”¨æ¨¡å‹å¹¶å¡«å……ä¸‹æ‹‰
            function loadModelList() {
                fetch('/api/list_models')
                    .then(r => r.json())
                    .then(data => {
                        // è°ƒè¯•è¾“å‡ºï¼šæ‰“å°åç«¯è¿”å›çš„åŸå§‹æ•°æ®ï¼Œä¾¿äºå®šä½ undefined é—®é¢˜
                        console.log('/api/list_models ->', data);
                        if (data.status === 'success') {
                            const select = document.getElementById('model-select');
                            select.innerHTML = '<option value=""></option>';
                            // cache models for later display
                            window.__available_models = data.models;
                            data.models.forEach(m => {
                                const opt = document.createElement('option');
                                const fname = m.filename || m.id || m.display || '';
                                opt.value = fname;
                                const label = (m.display || fname) + (m.modified ? ` (${m.modified})` : '');
                                opt.textContent = label;
                                select.appendChild(opt);
                            });
                            // after populating, attach change handler to show params
                            select.addEventListener('change', function(){
                                const val = this.value;
                                const info = document.getElementById('model-info');
                                info.innerHTML = '';
                                if (!val) return;
                                const chosen = (window.__available_models||[]).find(x => (x.filename===val || x.id===val || x.display===val));
                                if (!chosen) return;
                                // show params
                                const params = chosen.model_params;
                                const container = document.createElement('div');
                                if (chosen.training_plot) {
                                    const img = document.createElement('img');
                                    img.src = '/' + chosen.training_plot.replace(/^\/+/, '');
                                    img.style.maxWidth = '180px';
                                    img.style.display = 'block';
                                    img.style.marginBottom = '8px';
                                    container.appendChild(img);
                                }
                                if (params) {
                                    const ul = document.createElement('ul');
                                    ul.style.margin = '0';
                                    ul.style.paddingLeft = '18px';
                                    ['model_type','batch_size','learning_rate','epochs','optimizer_type','save_time'].forEach(k => {
                                        if (k in params) {
                                            const li = document.createElement('li');
                                            li.textContent = `${k}: ${params[k]}`;
                                            ul.appendChild(li);
                                        }
                                    });
                                    container.appendChild(ul);
                                }
                                info.appendChild(container);
                            });
                        }
                    })
                    .catch(err => console.log('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥', err));
            }

            document.getElementById('refresh-models').addEventListener('click', function() {
                loadModelList();
            });

            // é¦–æ¬¡åŠ è½½æ¨¡å‹åˆ—è¡¨
            loadModelList();
        });
    </script>
</body>
</html>