<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®å‡†å¤‡ - å›¾åƒè¯†åˆ«å¤§è¯¾è®¾</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .section-title {
            margin-bottom: 30px;
            color: #343a40;
            font-weight: 600;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #667eea;
            border-color: #667eea;
        }
        .btn-primary:hover {
            background-color: #5a67d8;
            border-color: #5a67d8;
        }
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        .data-info {
            margin-top: 30px;
        }
        .info-item {
            margin-bottom: 15px;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .sample-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .sample-item {
            text-align: center;
        }
        .sample-label {
            font-size: 0.9rem;
            margin-top: 5px;
            color: #495057;
        }
        .dataset-option {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .dataset-option:hover {
            background-color: #f8f9fa;
        }
        .dataset-option.selected {
            background-color: #e3f2fd;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">å›¾åƒè¯†åˆ«å¤§è¯¾è®¾</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/prepare_data">æ•°æ®å‡†å¤‡</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/config">æ¨¡å‹é…ç½®</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/train">æ¨¡å‹è®­ç»ƒ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/results">è®­ç»ƒç»“æœ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/predict">å›¾åƒé¢„æµ‹</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="section-title">æ•°æ®å‡†å¤‡</h1>
        
        <!-- æ•°æ®é›†é€‰æ‹© -->
        <div class="card">
            <div class="card-body">
                <h3>é€‰æ‹©æ•°æ®é›†</h3>
                <p>è¯·é€‰æ‹©è¦ä½¿ç”¨çš„æ•°æ®é›†ç±»å‹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç¤ºä¾‹æ•°æ®é›†æˆ–ä¸Šä¼ è‡ªå·±çš„æ•°æ®é›†ã€‚</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="border p-4 rounded dataset-option selected" id="sample-dataset">
                            <h4>ğŸ“Š ç¤ºä¾‹æ•°æ®é›†</h4>
                            <p>ä½¿ç”¨å†…ç½®çš„CIFAR-10å­é›†ä½œä¸ºç¤ºä¾‹æ•°æ®ï¼ŒåŒ…å«10ä¸ªç±»åˆ«çš„å›¾åƒã€‚</p>
                            <ul>
                                <li>10ä¸ªç±»åˆ«ï¼šé£æœºã€æ±½è½¦ã€é¸Ÿç±»ã€çŒ«ã€é¹¿ã€ç‹—ã€é’è›™ã€é©¬ã€èˆ¹ã€å¡è½¦</li>
                                <li>è®­ç»ƒé›†ï¼šçº¦400å¼ å›¾åƒ</li>
                                <li>æµ‹è¯•é›†ï¼šçº¦100å¼ å›¾åƒ</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border p-4 rounded dataset-option" id="custom-dataset">
                            <h4>ğŸ“ è‡ªå®šä¹‰æ•°æ®é›†</h4>
                            <p>ä½¿ç”¨æ‚¨è‡ªå·±çš„å›¾åƒæ•°æ®é›†ã€‚éœ€è¦æŒ‰ç…§ç‰¹å®šçš„ç›®å½•ç»“æ„ç»„ç»‡æ•°æ®ã€‚</p>
                            <p><strong>ç›®å½•ç»“æ„è¦æ±‚ï¼š</strong></p>
                            <pre>data/
â”œâ”€â”€ train/
â”‚   â”œâ”€â”€ class1/
â”‚   â”œâ”€â”€ class2/
â”‚   â””â”€â”€ ...
â””â”€â”€ test/
    â”œâ”€â”€ class1/
    â”œâ”€â”€ class2/
    â””â”€â”€ ...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œåŒºåŸŸ -->
        <div class="card">
            <div class="card-body">
                <h3>å‡†å¤‡æ“ä½œ</h3>
                
                <div id="sample-actions" class="action-section">
                    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½å¹¶å‡†å¤‡ç¤ºä¾‹æ•°æ®é›†ã€‚æ­¤è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚</p>
                    <button id="prepare-sample-btn" class="btn btn-primary">
                        ğŸ“¥ å‡†å¤‡ç¤ºä¾‹æ•°æ®é›†
                    </button>
                    <hr/>
                    <p>æˆ–ç›´æ¥ä¸€é”®å‡†å¤‡ COIL-20 æ•°æ®é›†ï¼ˆåŒ…å« 20 ä¸ªç‰©ä½“ç±»åˆ«ï¼‰ã€‚</p>
                    <button id="prepare-coil20-btn" class="btn btn-primary">
                        âš™ï¸ ä¸€é”®å‡†å¤‡ COIL-20 æ•°æ®é›†
                    </button>
                </div>
                
                <div id="custom-actions" class="action-section" style="display: none;">
                    <p>è¯·ç¡®ä¿æ‚¨çš„æ•°æ®é›†å·²æŒ‰ç…§è¦æ±‚çš„ç›®å½•ç»“æ„æ”¾ç½®åœ¨ <code>data/</code> æ–‡ä»¶å¤¹ä¸­ã€‚</p>
                    <button id="verify-custom-btn" class="btn btn-primary">
                        âœ… éªŒè¯æ•°æ®é›†
                    </button>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div class="progress-container" id="progress-container">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <p id="progress-message" class="mt-2 text-muted"></p>
                </div>
            </div>
        </div>

        <!-- æ•°æ®é›†ä¿¡æ¯ -->
        <div id="dataset-info" class="card data-info" style="display: none;">
            <div class="card-body">
                <h3>ğŸ“Š æ•°æ®é›†ä¿¡æ¯</h3>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <span class="info-label">æ•°æ®é›†ç±»å‹: </span>
                            <span id="dataset-type"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ç±»åˆ«æ•°é‡: </span>
                            <span id="num-classes"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è®­ç»ƒé›†å¤§å°: </span>
                            <span id="train-size"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æµ‹è¯•é›†å¤§å°: </span>
                            <span id="test-size"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ç±»åˆ«åˆ—è¡¨: </span>
                            <div id="class-list"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>æ ·æœ¬å›¾åƒ</h4>
                        <div id="sample-images" class="sample-grid">
                            <!-- æ ·æœ¬å›¾åƒå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="/config" class="btn btn-primary">
                    â¡ï¸ ç»§ç»­é…ç½®æ¨¡å‹
                </a>
            </div>
        </div>
    </div>

    <footer class="mt-10 py-5 bg-dark text-white">
        <div class="container text-center">
            <p>&copy; 2023 å›¾åƒè¯†åˆ«å¤§è¯¾è®¾ - æ·±åº¦å­¦ä¹ é¡¹ç›®</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ•°æ®é›†é€‰é¡¹åˆ‡æ¢
            const sampleDataset = document.getElementById('sample-dataset');
            const customDataset = document.getElementById('custom-dataset');
            const sampleActions = document.getElementById('sample-actions');
            const customActions = document.getElementById('custom-actions');
            
            sampleDataset.addEventListener('click', function() {
                sampleDataset.classList.add('selected');
                customDataset.classList.remove('selected');
                sampleActions.style.display = 'block';
                customActions.style.display = 'none';
            });
            
            customDataset.addEventListener('click', function() {
                customDataset.classList.add('selected');
                sampleDataset.classList.remove('selected');
                customActions.style.display = 'block';
                sampleActions.style.display = 'none';
            });
            
            // å‡†å¤‡ç¤ºä¾‹æ•°æ®é›†
            const prepareSampleBtn = document.getElementById('prepare-sample-btn');
            const prepareCoil20Btn = document.getElementById('prepare-coil20-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressMessage = document.getElementById('progress-message');
            
            prepareSampleBtn.addEventListener('click', function() {
                prepareSampleBtn.disabled = true;
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', '0');
                progressBar.textContent = '0%';
                progressMessage.textContent = 'æ­£åœ¨å‡†å¤‡ç¤ºä¾‹æ•°æ®é›†...';
                
                // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    if (progress <= 100) {
                        progressBar.style.width = progress + '%';
                        progressBar.setAttribute('aria-valuenow', progress);
                        progressBar.textContent = progress + '%';
                        
                        if (progress < 30) {
                            progressMessage.textContent = 'æ­£åœ¨ä¸‹è½½æ•°æ®é›†...';
                        } else if (progress < 70) {
                            progressMessage.textContent = 'æ­£åœ¨å¤„ç†æ•°æ®...';
                        } else {
                            progressMessage.textContent = 'æ­£åœ¨åˆ†å‰²æ•°æ®é›†...';
                        }
                    } else {
                        clearInterval(interval);
                    }
                }, 150);
                
                // è°ƒç”¨APIå‡†å¤‡æ•°æ®é›†
                fetch('/api/prepare_sample_data')
                    .then(response => response.json())
                    .then(data => {
                        clearInterval(interval);
                        
                        if (data.status === 'success') {
                            progressBar.style.width = '100%';
                            progressBar.setAttribute('aria-valuenow', '100');
                            progressBar.textContent = '100%';
                            
                            if (data.data_already_prepared) {
                                progressMessage.textContent = 'æ•°æ®é›†å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤ä¸‹è½½ï¼';
                            } else {
                                progressMessage.textContent = 'æ•°æ®é›†å‡†å¤‡æˆåŠŸï¼';
                            }
                            
                            // æ˜¾ç¤ºæ•°æ®é›†ä¿¡æ¯
                            setTimeout(() => {
                                document.getElementById('dataset-info').style.display = 'block';
                                document.getElementById('dataset-type').textContent = 'CIFAR-10å­é›†';
                                document.getElementById('num-classes').textContent = '10';
                                document.getElementById('train-size').textContent = 'çº¦400å¼ å›¾åƒ';
                                document.getElementById('test-size').textContent = 'çº¦100å¼ å›¾åƒ';
                                
                                const classes = ['plane', 'car', 'bird', 'cat', 'deer', 'dog', 'frog', 'horse', 'ship', 'truck'];
                                const classList = document.getElementById('class-list');
                                classList.innerHTML = classes.join(', ');
                                
                                // åŠ è½½å®é™…æ ·æœ¬å›¾åƒè€Œä¸æ˜¯å ä½ç¬¦
                                const sampleImages = document.getElementById('sample-images');
                                sampleImages.innerHTML = '';
                                
                                // ä¸ºæ¯ä¸ªç±»åˆ«å®šä¹‰ä¸åŒçš„é¢œè‰²
                                const classColors = {
                                    'plane': '#3498db',  // è“è‰²
                                    'car': '#e74c3c',    // çº¢è‰²
                                    'bird': '#2ecc71',   // ç»¿è‰²
                                    'cat': '#f39c12',    // æ©™è‰²
                                    'deer': '#9b59b6',   // ç´«è‰²
                                    'dog': '#1abc9c',    // é’ç»¿è‰²
                                    'frog': '#7f8c8d',   // ç°è‰²
                                    'horse': '#d35400',  // æ£•è‰²
                                    'ship': '#2980b9',   // æ·±è“è‰²
                                    'truck': '#e67e22'   // æ·±æ©™è‰²
                                };
                                
                                // ç”Ÿæˆå†…è”SVGå›¾åƒçš„å‡½æ•°
                                function generateSVGPlaceholder(width, height, bgColor, text, textColor = '#ffffff') {
                                    const fontSize = Math.min(width * 0.3, 24);
                                    const svgContent = `data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='${width}' height='${height}'%3E%3Crect width='100%25' height='100%25' fill='${bgColor.replace('#', '%23')}'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial, sans-serif' font-size='${fontSize}' fill='${textColor.replace('#', '%23')}' text-anchor='middle' dominant-baseline='middle'%3E${encodeURIComponent(text)}%3C/text%3E%3C/svg%3E`;
                                    return svgContent;
                                }
                                
                                // æ˜¾ç¤ºæ‰€æœ‰10ä¸ªç±»åˆ«çš„æ ·æœ¬å›¾åƒ
                                classes.forEach(cls => {
                                    const sampleItem = document.createElement('div');
                                    sampleItem.className = 'sample-item';
                                    
                                    // ä½¿ç”¨å†…è”SVGä½œä¸ºå ä½ç¬¦å›¾åƒ
                                    const color = classColors[cls] || '#3498db';
                                    const img = document.createElement('img');
                                    img.className = 'sample-image';
                                    img.alt = cls;
                                    // ç”Ÿæˆå†…è”SVGå›¾åƒæ•°æ®URL
                                    img.src = generateSVGPlaceholder(150, 150, color, cls);
                                    
                                    sampleItem.appendChild(img);
                                    
                                    const label = document.createElement('div');
                                    label.className = 'sample-label';
                                    label.textContent = cls;
                                    sampleItem.appendChild(label);
                                    
                                    sampleImages.appendChild(sampleItem);
                                });
                            }, 500);
                        } else {
                            progressMessage.textContent = `é”™è¯¯: ${data.message}`;
                            progressMessage.classList.add('text-danger');
                            prepareSampleBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        clearInterval(interval);
                        progressMessage.textContent = 'å‡†å¤‡æ•°æ®é›†æ—¶å‡ºé”™';
                        progressMessage.classList.add('text-danger');
                        prepareSampleBtn.disabled = false;
                        console.error('å‡†å¤‡æ•°æ®é›†æ—¶å‡ºé”™:', error);
                    });
            });

            // ä¸€é”®å‡†å¤‡ COIL-20 æ•°æ®é›†
            prepareCoil20Btn.addEventListener('click', function() {
                prepareCoil20Btn.disabled = true;
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', '0');
                progressBar.textContent = '0%';
                progressMessage.textContent = 'æ­£åœ¨å‡†å¤‡ COIL-20 æ•°æ®é›†...';

                let progress = 0;
                const interval = setInterval(() => {
                    progress += 6;
                    if (progress <= 100) {
                        progressBar.style.width = progress + '%';
                        progressBar.setAttribute('aria-valuenow', progress);
                        progressBar.textContent = progress + '%';
                        if (progress < 30) {
                            progressMessage.textContent = 'æ­£åœ¨ä¸‹è½½æˆ–è¯»å–å‹ç¼©åŒ…...';
                        } else if (progress < 70) {
                            progressMessage.textContent = 'æ­£åœ¨è§£å‹ä¸æ•´ç†ä¸º ImageFolder...';
                        } else {
                            progressMessage.textContent = 'æ­£åœ¨ç”Ÿæˆæ•°æ®ç»Ÿè®¡...';
                        }
                    } else {
                        clearInterval(interval);
                    }
                }, 150);

                fetch('/api/prepare_coil20', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'started' && data.job_id) {
                            const jobId = data.job_id;
                            const poller = setInterval(() => {
                                fetch(`/api/prepare_coil20_status?job_id=${jobId}`)
                                    .then(r => r.json())
                                    .then(s => {
                                        // ç”¨åç«¯è¿›åº¦æ›´æ–°è¿›åº¦æ¡
                                        if (typeof s.progress === 'number') {
                                            progressBar.style.width = s.progress + '%';
                                            progressBar.setAttribute('aria-valuenow', s.progress);
                                            progressBar.textContent = s.progress + '%';
                                        }
                                        if (s.message) {
                                            progressMessage.textContent = s.message;
                                        }
                                        if (s.status === 'completed' && s.result) {
                                            clearInterval(interval);
                                            clearInterval(poller);
                                            progressBar.style.width = '100%';
                                            progressBar.setAttribute('aria-valuenow', '100');
                                            progressBar.textContent = '100%';
                                            progressMessage.textContent = s.message || 'COIL-20 æ•°æ®é›†å‡†å¤‡å®Œæˆï¼';

                                            // æ˜¾ç¤ºæ•°æ®é›†ä¿¡æ¯
                                            setTimeout(() => {
                                                document.getElementById('dataset-info').style.display = 'block';
                                                document.getElementById('dataset-type').textContent = 'COIL-20';
                                                document.getElementById('num-classes').textContent = (s.result.classes || []).length;
                                                document.getElementById('train-size').textContent = s.result.train_size || '-';
                                                document.getElementById('test-size').textContent = s.result.test_size || '-';

                                                const classList = document.getElementById('class-list');
                                                classList.innerHTML = (s.result.classes || []).join(', ');

                                                const sampleImages = document.getElementById('sample-images');
                                                sampleImages.innerHTML = '';
                                                (s.result.classes || []).slice(0, 10).forEach(cls => {
                                                    const sampleItem = document.createElement('div');
                                                    sampleItem.className = 'sample-item';
                                                    const img = document.createElement('img');
                                                    img.className = 'sample-image';
                                                    img.alt = cls;
                                                    img.src = `data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect width='100%25' height='100%25' fill='%23667eea'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial, sans-serif' font-size='20' fill='%23ffffff' text-anchor='middle' dominant-baseline='middle'%3E${encodeURIComponent(cls)}%3C/text%3E%3C/svg%3E`;
                                                    sampleItem.appendChild(img);
                                                    const label = document.createElement('div');
                                                    label.className = 'sample-label';
                                                    label.textContent = cls;
                                                    sampleItem.appendChild(label);
                                                    sampleImages.appendChild(sampleItem);
                                                });
                                            }, 500);
                                            prepareCoil20Btn.disabled = false;
                                        } else if (s.status === 'error') {
                                            clearInterval(interval);
                                            clearInterval(poller);
                                            progressMessage.textContent = `é”™è¯¯: ${s.message || 'ä»»åŠ¡å¤±è´¥'}`;
                                            progressMessage.classList.add('text-danger');
                                            prepareCoil20Btn.disabled = false;
                                        }
                                    })
                                    .catch(err => {
                                        clearInterval(interval);
                                        clearInterval(poller);
                                        progressMessage.textContent = 'æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€æ—¶å‡ºé”™';
                                        progressMessage.classList.add('text-danger');
                                        prepareCoil20Btn.disabled = false;
                                        console.error('æŸ¥è¯¢çŠ¶æ€å‡ºé”™:', err);
                                    });
                            }, 1000);
                        } else {
                            clearInterval(interval);
                            progressMessage.textContent = `é”™è¯¯: ${data.message || 'æ— æ³•å¯åŠ¨ä»»åŠ¡'}`;
                            progressMessage.classList.add('text-danger');
                            prepareCoil20Btn.disabled = false;
                        }
                    })
                    .catch(error => {
                        clearInterval(interval);
                        progressMessage.textContent = 'å‡†å¤‡ COIL-20 æ•°æ®é›†æ—¶å‡ºé”™';
                        progressMessage.classList.add('text-danger');
                        prepareCoil20Btn.disabled = false;
                        console.error('å‡†å¤‡ COIL-20 æ•°æ®é›†æ—¶å‡ºé”™:', error);
                    });
            });
            // éªŒè¯è‡ªå®šä¹‰æ•°æ®é›†
            const verifyCustomBtn = document.getElementById('verify-custom-btn');
            verifyCustomBtn.addEventListener('click', function() {
                alert('è¯·ç¡®ä¿æ‚¨çš„æ•°æ®é›†å·²æŒ‰ç…§è¦æ±‚çš„ç›®å½•ç»“æ„æ”¾ç½®ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæœ‰ä¸€ä¸ªéªŒè¯è¿‡ç¨‹ã€‚');
                // è¿™é‡Œå¯ä»¥æ·»åŠ éªŒè¯è‡ªå®šä¹‰æ•°æ®é›†çš„é€»è¾‘
            });
        });
    </script>
</body>
</html>