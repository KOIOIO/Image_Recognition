<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模型对比 - 图像识别大课设</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background:#f8f9fa }
        .card { border-radius:10px }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">图像识别大课设</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/train">模型训练</a></li>
                    <li class="nav-item"><a class="nav-link" href="/predict">图像预测</a></li>
                    <li class="nav-item active"><a class="nav-link" href="/compare">模型对比</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-3">模型对比</h1>

        <div class="card mb-3">
            <div class="card-body">
                <p>从下方列表选择要对比的模型（至少 2 个），点击 <strong>对比</strong>。</p>
                <div id="models-list" class="mb-3"></div>
                <button id="compare-btn" class="btn btn-primary">对比</button>
                <button id="refresh-btn" class="btn btn-outline-secondary ms-2">刷新模型列表</button>
            </div>
        </div>

        <div id="results-area" style="display:none">
            <div class="card mb-3">
                <div class="card-body">
                    <h5>训练曲线对比</h5>
                    <canvas id="curve-chart" width="800" height="300"></canvas>
                    <div id="curve-thumbs" style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;"></div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <h5>混淆矩阵缩略图</h5>
                    <div id="confusion-thumbs" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <h5>对比结果表</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="results-table">
                            <thead>
                                <tr><th>模型</th><th>测试准确率 (%)</th><th>测试损失</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5>准确率对比图</h5>
                    <canvas id="acc-chart" width="800" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function loadModels(){
            const el = document.getElementById('models-list');
            el.innerHTML = '加载中...';
            try{
                const res = await fetch('/api/list_models');
                const data = await res.json();
                el.innerHTML = '';
                if(data.status === 'success'){
                    // cache for compare usage
                    window.__available_compare_models = data.models;
                    data.models.forEach(m => {
                        const fname = m.filename || m.id || m.display || '';
                        const safeId = 'm_' + fname.replace(/[^a-zA-Z0-9_.-]/g, '');
                        const card = document.createElement('div');
                        card.className = 'card mb-2 p-2';
                        card.style.display = 'flex';
                        card.style.alignItems = 'center';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'form-check-input me-2';
                        checkbox.value = fname;
                        checkbox.id = safeId;

                        const metaDiv = document.createElement('div');
                        metaDiv.style.display = 'flex';
                        metaDiv.style.alignItems = 'center';

                        if (m.training_plot) {
                            const img = document.createElement('img');
                            img.src = '/' + m.training_plot.replace(/^\/+/, '');
                            img.style.width = '120px';
                            img.style.height = '80px';
                            img.style.objectFit = 'cover';
                            img.style.marginRight = '12px';
                            metaDiv.appendChild(img);
                        }

                        const info = document.createElement('div');
                        const label = (m.display || fname) + (m.modified ? ` (${m.modified})` : '');
                        const title = document.createElement('div');
                        title.textContent = label;
                        title.style.fontWeight = '600';
                        info.appendChild(title);
                        if (m.model_params) {
                            const p = document.createElement('div');
                            p.style.fontSize = '0.9em';
                            p.style.color = '#666';
                            const mp = m.model_params;
                            p.textContent = `type:${mp.model_type||''} lr:${mp.learning_rate||''} bs:${mp.batch_size||''} epochs:${mp.epochs||''}`;
                            info.appendChild(p);
                        }

                        metaDiv.appendChild(info);

                        card.appendChild(checkbox);
                        card.appendChild(metaDiv);
                        el.appendChild(card);
                    });
                } else {
                    el.innerHTML = '<div class="text-danger">无法加载模型列表</div>';
                }
            }catch(e){
                el.innerHTML = '<div class="text-danger">加载模型列表出错</div>';
            }
        }

        async function compare(){
            const checks = Array.from(document.querySelectorAll('#models-list input[type=checkbox]:checked'));
            if(checks.length < 2){ alert('请选择至少两个模型进行对比'); return; }
            const models = checks.map(c => c.value);
            document.getElementById('compare-btn').disabled = true;
            // prepare selected model metadata for curve drawing and thumbnails
            const selectedMeta = (window.__available_compare_models||[]).filter(m=> models.includes(m.filename || m.id || m.display));
            try{
                const res = await fetch('/api/compare_models', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({models})
                });
                const data = await res.json();
                if(data.status === 'success'){
                    showResults(data.results);
                    // render training curves from selectedMeta
                    renderTrainingCurves(selectedMeta);
                    renderConfusionThumbnails(selectedMeta);
                } else {
                    alert('对比失败: '+(data.message||'未知错误'));
                }
            }catch(e){ alert('请求出错:'+e); }
            document.getElementById('compare-btn').disabled = false;
        }

        // 绘制训练曲线（多模型对比）
        let curveChart = null;
        function renderTrainingCurves(modelsMeta){
            const ctx = document.getElementById('curve-chart').getContext('2d');
            const labels = [];
            const datasets = [];
            const colors = ['#667eea','#48bb78','#f6ad55','#ed64a6','#63b3ed','#a0aec0'];
            modelsMeta.forEach((m, idx) => {
                const mr = m.train_results;
                const name = m.display || m.filename || m.id || `model${idx}`;
                if (mr && mr.train_accuracies && mr.test_accuracies) {
                    const epochs = mr.train_accuracies.length;
                    // create labels once
                    if (labels.length === 0) {
                        for (let e=1;e<=epochs;e++) labels.push('E'+e);
                    }
                    const color = colors[idx % colors.length];
                    datasets.push({ label: `${name} - train`, data: mr.train_accuracies, borderColor: color, fill:false });
                    datasets.push({ label: `${name} - test`, data: mr.test_accuracies, borderColor: color, borderDash:[5,5], fill:false });
                }
            });
            if (curveChart) curveChart.destroy();
            curveChart = new Chart(ctx, { type: 'line', data:{ labels, datasets }, options:{ responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true, max:100 } } } });
            // 同时显示每个模型的训练曲线图片作为回退（若存在 training_plot）
            renderCurveThumbnails(modelsMeta);
        }

        function renderCurveThumbnails(modelsMeta){
            const container = document.getElementById('curve-thumbs');
            container.innerHTML = '';
            modelsMeta.forEach(m=>{
                const name = m.display || m.filename || m.id || '';
                const wrapper = document.createElement('div');
                wrapper.style.width = '240px';
                wrapper.style.textAlign = 'center';
                const title = document.createElement('div'); title.textContent = name; title.style.fontWeight='600'; title.style.marginBottom='6px';
                wrapper.appendChild(title);
                if (m.training_plot){
                    const img = document.createElement('img');
                    img.src = '/' + m.training_plot.replace(/^\/+/, '');
                    img.style.width = '240px'; img.style.height = '140px'; img.style.objectFit='contain'; img.style.border='1px solid #eee';
                    wrapper.appendChild(img);
                } else if (m.train_results && m.train_results.train_accuracies){
                    const p = document.createElement('div'); p.textContent = '存在训练结果，可绘制曲线'; p.style.color='#666'; wrapper.appendChild(p);
                } else {
                    const p = document.createElement('div'); p.textContent = '无训练曲线'; p.style.color='#999'; wrapper.appendChild(p);
                }
                container.appendChild(wrapper);
            });
        }

        function renderConfusionThumbnails(modelsMeta){
            const container = document.getElementById('confusion-thumbs');
            container.innerHTML = '';
            modelsMeta.forEach(m=>{
                const name = m.display || m.filename || m.id;
                const box = document.createElement('div');
                box.style.width='180px';
                box.style.textAlign='center';
                const title = document.createElement('div'); title.textContent = name; title.style.fontWeight='600'; title.style.marginBottom='6px';
                box.appendChild(title);
                if (m.confusion_matrix) {
                    const img = document.createElement('img');
                    img.src = '/' + m.confusion_matrix.replace(/^\/+/, '');
                    img.style.width='180px'; img.style.height='140px'; img.style.objectFit='contain';
                    box.appendChild(img);
                } else {
                    const p = document.createElement('div'); p.textContent='无混淆矩阵'; p.style.color='#999'; box.appendChild(p);
                }
                container.appendChild(box);
            });
        }

        function showResults(results){
            const area = document.getElementById('results-area');
            const tbody = document.querySelector('#results-table tbody');
            tbody.innerHTML = '';
            const labels = [];
            const accs = [];
            results.forEach(r => {
                if(r.error){
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.model}</td><td colspan=2 class='text-danger'>${r.error}</td>`;
                    tbody.appendChild(tr);
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.model}</td><td>${(r.test_accuracy).toFixed(2)}</td><td>${(r.test_loss).toFixed(4)}</td>`;
                    tbody.appendChild(tr);
                    labels.push(r.model);
                    accs.push(r.test_accuracy);
                }
            });

            area.style.display = 'block';
            renderChart(labels, accs);
        }

        let chart = null;
        function renderChart(labels, data){
            const ctx = document.getElementById('acc-chart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar', data: { labels, datasets:[{label:'测试准确率 (%)', data, backgroundColor:'#667eea'}] },
                options: { scales:{ y:{ beginAtZero:true, max:100 } } }
            });
        }

        document.getElementById('compare-btn').addEventListener('click', compare);
        document.getElementById('refresh-btn').addEventListener('click', loadModels);
        loadModels();
    </script>
</body>
</html>
